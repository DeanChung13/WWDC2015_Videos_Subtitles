《HealthKit最新內容》
大家好歡迎來到《HealthKit最新內容》講座
這是幫大家瞭解今年在SDK中最新內容的絕好機會
我是香農·譚是iOS工程師
稍後我的同事艾倫·肖特利奇也會上臺
我們很激動能幫助大家搭建有效應用
來幫助數百萬民衆能過上更健康更好的生活
我們先從講座的路線圖開始
今天我們將談到幾項不同的內容
我們將快速過一遍HealthKit
還會介紹在iOS 8.2中引入的單位偏好API
並會談到iOS 9的糖尿一族
可以用到HealthKit支持的軟件的全新功能
接下來艾倫會上臺來介紹數據源刪除和Workout會話
最後我們會介紹WatchKit的演示
先來談談HealthKit的背景
現在個人健康是個非常活躍的領域
在App Store中
有許多app都是在幫助用戶獲得並保持健康狀態
運動跟蹤器和智能手錶
這類設備可以記錄大量極爲私人的相關數據
HealthKit框架使存儲和提取這類信息變得非常容易
它可以提供豐富的API來保存健康和健身數據並在應用間分享
同時還能在極爲隱私的環境下 使用加密數據庫中確保安全
對於app開發人員而言這意味着什麼？
意味着當你使用HealthKit時
你可以跳過編寫自定義編碼 來分享存儲和同步數據 
而可以更多關注app體驗的核心功能
同時還是更出色的生態系統的組成部分
最後 有了HealthKit還誕生了Health app
這可以提供HealthKit的全視圖
在iOS 9中我們增加了更多視圖
以便於用戶存儲 總結並關聯數據
我們來談談支持這些出色的Health應用的數據類型
目前在HealthKit 有着許多數據類型
其中涵蓋了個人健康的方方面面
我們試着將數據類型儘可能的廣泛和有效
有個常見問題
Apple怎樣能在有限的開發時間內對需要添加的數據類型進行優先安排
我們最重要的優先級考慮是存在硬件
例如可以自動跟蹤體重狀況的藍牙秤
可以測量你的睡眠情況的Sleeptracker
我們發現自動量化的健康數據
並同步到設備上的HealthKit很強大
我們也根據存在的軟件添加數據類型
是否已有的流行app可以圍繞這些數據類型生成體驗
最後我們會考慮顧客和開發人員的反饋
爲支持我們對數據類型的討論
我們現在來看它們的結構
HealthKit中的每個對象都有個類型
每個類型都會繼承HK對象類型
特徵類型不會隨着時間而改變
如血型或出生日期
隨着時間而改變的類型叫做樣本類型
我們會介紹兩種
數量樣本有着數量和單位 比如體重
類別樣本可以枚舉若干不同的值如睡眠分析
你可以是處於幾種睡眠狀態之一
當然這是在回顧已有的信息
如果想要了解更多HealthKit的構成
我們建議大家看看去年的講座
《HealthKit介紹》
我提到了數量樣本包括數量和單位
我將花些時間來介紹新的單位偏好API
雖然這款API不是iOS 9的內容但在iOS 8.2講座中我們介紹過
我們現在還想提一下
大家可能注意到在iOS 8.2
在Health app中有個新的單位窗格
根據yoghurt的地區和位置來顯示單元
但是用戶可以整理輸入這行數據 
用自己的單位偏好覆蓋默認的設置
在iOS 8.2中HK Health Store裏有新的類擴展
你可以用來發現單位偏好
我們建議這麼做
這樣你在app UI中顯示的單位就會
與用戶希望在Apple Health看到的相匹配
最後每當單位偏好發生改變時就會啓動新的通知
現在我們探討回顧了HealthKit中的單位數據類型
我們再來看在iOS 9中可用的新數據類型
首先是水攝取量
我相信大家都知道有人會隨身帶個巨大水瓶
別人要是問起來他會解釋說
每天補水對健康很重要
若是整天都覺得很渴也許的確很糟
在App Store有許多app會溫和地督促你增加水攝取量
甚至會有部分設備和傳感器如藍牙水瓶 可以跟蹤你的水攝取量
很多人都希望確保自己每天的飲水可以達到8個8盎司杯
或是兩升的推薦標準
如果運動強度較大有脫水風險人們可能會需要更多水
因此我們在HealthKit中增加新的數量類型Dietary Water
這是單位是體積
它的字面意思是指膳食水這類型也可以跟蹤通過食物攝取的水分
接下來的類型是UV Exposure
紫外線輻射存在於日光當中對人體健康產生正面和負面的作用
它還可以促進維生素D的形成
還可以改善情緒和健康水平
但過度暴露在紫外線下會產生負面作用
會對人體產生負面影響 如曬傷或長期影響 如皮膚損傷或白內障
如果你要在陽光下呆上一段時間那麼瞭解何時有曬傷風險會很有幫助
還有一些很精巧的設備可以跟蹤人暴露在紫外線照射下的情況
針對這類app和傳感器
我們添加了新的數量類型UV Exposure
其中的值是標量代表紫外線指數是從0到12
代表從最無害到最危險
當然紫外線照射並非是衡量我們的日曬風險的最理想方式
這可能會取決於你所穿的衣服
你所用的防曬霜或你的皮膚類型
針對最後一點我們在HealthKit中
增加了新的特徵類型Fitzpatrick Skin Type
這代表了根據菲氏量表的個人皮膚類型來反映曬傷或曬黑的情況
iOS 8.3的表情符號就是根據菲氏量表做成
左邊的所有都是1型代表很容易曬傷的很淺膚色
右邊的都是永遠不會曬傷或嚴重曬黑的深棕色或黑色皮膚
因爲Fitzpatrick Skin Type是特徵類型
因此它與大家可能用過的類別或數量樣本都不相同
它可以通過Health Store直接訪問
並返回枚舉的簡單包裝類
現在我想來談談在生殖健康類別下我們添加的全新數據類型
當想到量化健康時
我們會想到技術驅動項目如運動跟蹤器和智能手錶
我們會想到用HealthKit同步健身數據
也許會將營養成分自動輸入美食日記
但是生殖健康是很重要的健康內容
很多跟蹤記錄健康數據的女性都知道月經週期是令人興奮或相當重要的數據
對於許多想要懷孕生子的夫妻和許多不想要孩子的夫妻來說
排卵期 理解荷爾蒙變化或紊亂的監測結果是非常重要的信息
也許談論這些敏感甚至私密的數據會令人感覺有些奇怪
可是當我們談到技術改善生活時這些都是非常關鍵重要而有意義的信息
它幫助女性理解並瞭解自己的身體狀況從而可以控制健康情況
它可以幫助並已幫助數百萬人
在瞭解可靠信息的基礎上對生育和計劃生育做出決策
跟蹤排卵期的app是
App Store中Health和Fitness類別下最受歡迎的app產品 
這也是HealthKit第一大開發要求
我們很興奮能在iOS 9中爲這些app提供支持
在生殖健康方面有着許多因素
我們先從6個新類型開始
這些都是公開內容也許對想要寶寶的人或是不想懷孕
或希望對自己的健康狀況全面瞭解的人都會有所幫助
第一種是Basal Body Temperature
針對每種類型我們會在Apple Health中
添加控制圖給大家看到數據視覺化
基礎體溫是身體在休息狀態下的溫度
通常是在清晨測量
它呈現雙相變化在排卵後會稍稍上升
人們常常會在同一時間一連數月跟蹤基礎體溫
這樣就會得出週期圖形並可以大體預測下一個週期的時間
一般都是用鉛筆和紙張記錄的
這種跟蹤排卵的辦法由來已久
還有一種跟蹤或檢測排卵期的常見辦法是測量宮頸粘液質量
與基礎體溫的變化相反
宮頸粘液是在排卵期之前發生變化
在HealthKit中這是類別樣本
其中會列出醫學一般會接受的宮頸粘液狀態
我們添加的下一個類型是Ovulation Test Results
對女性來說 黃體生成素激增會導致排卵
用戶可以購買家庭測試套裝和LH試紙來測量LH高峯
在HealthKit這種類別樣本測量結果是陰性或陽性
經期是否健康是極其重要的指標
醫生經常會問及女性末次經期的時間以及生理週期的規律性情況
幫助人們記錄經期情況的App非常受歡迎而且種類繁多
在HealthKit中我們添加了類別樣本
我們還添加了新的元數據祕鑰
Menstrual Cycle Starts
因爲上次經期的時間和週期規律性是重要的醫學信息
我們要讓app便於計算這類信息才行
我們讓所有的客戶端都記錄這個布林元數據祕鑰
如果我們看不到就會拋出異常
我們再來看元數據
元數據是提供HealthKit對象額外信息的字典
可以幫助擴展規定的對象類型
併爲HealthKit添加具體app信息
字典祕鑰是你可以生成的字符串或是Apple預定義的祕鑰
預定義祕鑰可便於在不同的應用中分享
我們現在來生成包含
重要信息的元數據字典
在最後保存到HealthKit之前 
我們生成樣本時
會將樣本放入適當的數值類型並傳遞到元數據
接下來的兩個類型是類別樣本
但與HealthKit現有類別樣本不同它們只有單一的值
HK Category ValueNot Applicable
這些類別樣本有數據 元數據和其他屬性
它們無法列入多個值
因此這些類型中首先是陰道出血
這是指在經期以外發生的少量出血
因此它與經期不同
我們添加的第二類型是性生活
性生活在許多排卵跟蹤應用中也是相關的重要信息
我們在HealthKit中也增加了相應支持
還新添了可選預定義元數據祕鑰
Sexual Activity Protection Use
這是指預防性傳播疾病或防止懷孕
我們來總結一下
剛說過在iOS 9增加的新數據類型
Water Intake和UV Exposure和Fitzpatrick Skin Type
以及6種新的生殖健康類型
我們希望看到大家在自己的應用設備中會創造性地使用這些數據類型
現在有請艾倫來介紹數據源部分
謝謝 香農
大家好 我是艾倫
是Apple HealthKit團隊的軟件工程師
我們剛剛聽過香農
介紹了iOS 9中的HealthKit新類型
我來講講大家用iOS 9的HealthKit還能做些什麼
我要介紹的第一部分改變是關於數據源
HealthKit可以通過不同的源保存數據
可以從用戶iPhone中的Motion代碼處理器或連接的藍牙
心率監測器自動提取樣本
也可以是來自Health app手動輸入的樣本
或由諸位這樣的開發人員創建的應用保存的樣本
知道HealthKit的數據是來自哪裏很重要
特別是如果你在使用數據進行醫學或研究工作時 更是如此
那麼怎樣判定HealthKit的數據是來自哪裏呢？
HK對象類是所有存儲在HealthKit的根類
在iOS 8中它有數據源相關的兩個屬性
其一是Source屬性
它代表着用哪個應用保存該對象
第二個屬性是元數據
開發人員常用元數據存儲生成對象的外部設備信息
這些信息可以是外部設備的名稱或廠商名稱
在iOS 9中我們引入了兩個新屬性
可以提供對象來自何處的更豐富信息
這些新屬性中第一個是Source Revision屬性
而且替代了Source屬性
除了代表生成樣本的應用它還帶着保存對象的app版本
第二個是Device屬性
會返回代表生成對象的外部設備的對象
它本意是替代外部設備相關的元數據
我們再來看看HK Source Revision類
它有兩個屬性源代碼
同樣代表着...
不好意思
代表着保存數據的應用這樣它也包括版本字符串
當你在HealthKit中保存數據時
HealthKit會自動爲它賦值HK源代碼修改
版本字符串來自app的Info plist中的束版本輸入
在iOS 9之前 保存在HealthKit的對象
將會有空版本字符串
我們來談談HK Device
HK Device類包括若干
代表硬件設備不同方面的字符串
例如名稱廠家 版本信息 等等 
當你創建設備時 你需要向用戶提供儘可能多的適用屬性
並向其他應用提供對象來自哪裏的信息
如果你app保存的對象是由app設備上內置的感應器生成
你可以在HK Device上使用本地設備類方法
以獲取一個設備來代表你的app運行的設備
我們先來看怎樣在設備上保存樣本
首先你要創建具備所有適用屬性的設備
接下來使用一個採用設備的HK樣本子類
初始化方法實例化樣本
最後和之前一樣
你可以把對象保存到HealthKit 
查詢來自某個源代碼修改或設備的對象也很容易
你可以用新介紹的謂詞便捷方法來面對iOS 9中的HK Query
這裏的示例是查詢在之前版本應用中保存的對象
首先我們用默認源代碼生成源代碼修改和1.0版本的字符串
之後對謂詞實例化以匹配有着源代碼修改的所有樣本
最後我們會執行HK樣本查詢
它會返回給我們用應用版本1生成的所有對象
現在我們介紹了在HealthKit保存對象的新方法
再來介紹一些刪除對象的方法
iOS 8只有一種 刪除對象的方法
這就是HK Health Store中的Delete Object方法
它會刪除單獨的對象
這很簡單但若一次刪除多個樣本就會有些麻煩
我們現在引入了兩種新的便捷方法來刪除對象
第一種是HK Health Store的方法 
這可以刪除一組對象
每當你有之前查詢過的樣本系列
並想將之全部刪除時 可以用這個
例如 你也許想用HK Device
而不是元數據將之前版本的app保存樣本做轉移
一旦您保存了以往對象的新拷貝
你可用Delete Objects刪除所有舊對象
我們要介紹的第二個新方法就是
Delete Objects Of Type
因此它會刪除匹配給定謂詞的所有對象
這樣做很高效因爲你在刪除對象之前不必查詢
你並非總是要刪除對象有時你也會需要了解何時刪除的對象
也許是用戶或是另外的應用做了刪除
如果你的app與HealthKit同步
一旦從HealthKit的數據庫刪除對象
你最好從你的數據庫把對象刪除
在iOS 8沒有簡單的辦法來實現這點
我們引入了新方法
通過Anchored Object Query類 查詢 在iOS 9中刪除的對象
HK Anchored Object Query
有帶有結果處理器代碼塊的新初始程序
其中的參數包括新樣本和刪除的樣本
現在當你執行這個查詢時
HealthKit會返回自上次你運行錨定對象查詢後 
匹配謂詞的生成或刪除的所有樣本
這是由你所提供的錨來表明
刪除的對象通過HK Deleted Object類的
實例來代表其中攜帶了刪除對象的UID
爲節省空間
刪除對象僅在被永久銷燬前有限時間內存儲在HealthKit中
這意味着如果你有功能需要取決於查詢被刪除的對象
你應該註冊背景升級以確保你的app會因刪除而啓動
你可以使用iOS 8中的Enable Background Delivery For Type方法
它會因iOS 9中的刪除和樣本生成而啓動
現在我們回到HK Anchored Object Query
來談談在iOS 9中針對類的第二個新添內容
即Update Handler屬性
一旦提供
當生成或刪除匹配謂詞的更多樣本時在結果處理器之後就會調用代碼塊
有着更新處理器的HK錨定對象查詢會繼續無限期運行
直至你在HK Health Store用Stop Query停止它
在本次講座稍後的部分
你會看到這是
處理來自HealthKit的數據流的有效方法
例如你可能會想從HealthKit顯示用戶的最新心率數據
你可以使用更新處理器來實現
大家也許注意到
Apple最近推出了新的硬件它可以讀取佩戴者的心率
如果能從該設備上直接運行這個查詢會不會很酷？
而你的確可以
今年除了在iOS 9在對HealthKit做了改進
我們還帶來了WatchKit app的框架
watchOS上的HealthKit與iOS的HealthKit非常像
你所熟悉的幾乎所有HealthKit API
在watchOS中也都可用
你可以用習慣的相同查詢和方法來存儲和提取健康數據
但是因爲在新平臺上性能相當重要
只有有限的HealthKit歷史數據 在Watch上可用
我們還會介紹嶄新的健身API
這可以在Watch上記錄鍛鍊數據
最後在Watch的HealthKit中
保存的數據會自動同步到用戶的手機上
當你的app將鍛鍊數據保存到Apple Watch時
消耗的能量也會在運動環中記錄
你的用戶一定會喜歡佩戴Watch時使用你的app
大家可以在這些截屏中看到
你保存的鍛鍊數據
將會在iOS的Daily Summary和Activity app顯示 
在我進一步探討鍛鍊前我先要介紹有關隱私問題
我們相當重視用戶的HealthKit數據的隱私性
所以和iOS一樣我們自然會在Watch對之妥善保護
我們需要申請訪問權才能使用HealthKit數據
當你的app申請授權時
彈出框會同時出現在Watch和用戶的手機
來授權你的app可以訪問
假設 如果你的手機應用已經授權存儲並提取距離樣本
那麼也會授權Watch app存儲並提取距離樣本
一旦WatchKit app得到授權可以使用HealthKit數據
你可能就想記錄鍛鍊數據
我們引入了全新的
HK Workout Session類來實現這一點
有了HK Workout Session你可以明確用戶從事的運動類型
該信息將幫助Apple Watch更準確地記錄用戶的運動情況
在會話中你的app會位於前景
每當用戶擡起手腕檢查鍛鍊的進度時
你的app就會在前面居中的位置
注意在任何具體時間中 只有一個鍛鍊會話可以運行
如果用戶在另一個應用開始了另外的鍛鍊
你的鍛鍊會話就會結束
我們現在來看HK Workout Session
你會用運動類型和位置類型實例化鍛鍊會話
位置類型表明運動是否發生在室內還是戶外
你還可以設置委託
這可以實現告知你鍛鍊狀態發生了改變
那麼HK Workout Session委託協議有着兩種方式
每當鍛鍊發生改變時 就會調用第一種
例如從Not Started到Running或從Running到Ended
這是個不錯的機會可以記錄鍛鍊的開始和結束日期
同時還可以開始或停止任何可能的數據查詢
只要出現錯誤 就會調用第二種方法
會在第一種方法之外再調用它
並會表明你的鍛鍊會話已經結束
開始和停止鍛鍊會話其實很簡單
你只需要在HK Health Store
調用Start Workout Session或Stop Workout Session
現在我來快速解釋一下
怎樣用這些新款API搭建WatchKit app
我已經搭建了一個簡單的WatchKit應用
我要給大家看一下這個app怎麼用
它可以讓用戶規定從事的運動形式
例如跑步
我選擇跑步
一旦選定了運動類型它們就會選擇位置類型
戶外或室內
我選的是戶外
這是進行會話的視圖它會顯示該鍛鍊的幾項指標
在會話視圖中什麼都沒有因爲我們沒連上HealthKit 
我們現在就動手
在Xcode中我們看到我的運動界面控制器
這是第一個我們剛看到的視圖用戶選擇所從事的運動類型
這是我申請授權訪問HealthKit數據的絕好機會
我現在馬上就在這裏...
不好意思是Will Activate方法
首先我實例化了要分享的一組類型 其中就包括鍛鍊類型
接着我要從HealthKit讀取一系列類型
例如長途單車 長途步行還有跑步能量消耗以及用戶的心率
最後我們調用並申請授權來分享類型
這和iOS中一樣
現在我們需要在配套的應用中做點什麼來完成這個申請
在配套app的app委託中 
我將要執行新的UI應用委託方式
應用應該申請健康授權
我只需要爲完成擴展調用處理授權
這會提示用戶爲我的app授權
我們來看這個操作
大家可以看到
用戶會在Watch和手機上都得到提示打開我的app並授權
這是熟悉的健康授權表格
我批准app訪問它所需的任何內容
並點擊Allow
現在我們得到授權可使用HealthKit數據
接下來
我們需要在用戶點擊Start時開始鍛鍊會話
我這裏有Workout Session Manager類
這就是負責管理我和HealthKit互動的地方
這是個很大的類但是我們只會執行其中的一部分
我們點擊Start調用Start Workout方法
我希望開始之前在構造器上實例化的鍛鍊會話
我們只需要在包含鍛鍊會話的
HK Health Store調用Start Workout Session
現在我們需要執行鍛鍊會話委託協議這樣我們就會得知鍛鍊狀態發生的改變
因爲這是在背景提示中調用我在處理狀態
改變前 我在回調主隊列
如果會話狀態改爲Running 我會調用Workout Did方式
如果它改爲Ended我會調用Workout Did End
我們繼續Workout Did Start
我們需要爲HealthKit數據進行查詢
以便在鍛鍊中顯示
其中的一個指標是距離
我需要查詢從HealthKit蒐集距離數據
並把它累計到鍛鍊會話進度中
我將會生成助手方式在這裏生成查詢
我們還會使用HK Anchored Object用升級處理器來查詢
所以我編寫了Create Streaming Distance Query
它採用了鍛鍊開始日期
我們首先做的是生成一個謂詞
可以匹配所有查詢不好意思...
是鍛鍊開始日期後的所有樣本
接下來通過結果處理器我實例化了HK錨定對象查詢
並調用了Add Distance Samples方法
Add Distance Samples在這裏執行
它回調了主提示
並在我的總跑步距離中添加了距離樣本
也將樣本添加到我在鍛鍊過程中積累的一組樣本中
同樣在結果處理器中我們調用Add Distance Samples
並在更新處理器中我們做了完全一樣的內容
最後我們返回距離查詢
現在這已經在Workout Did Start中使用了
Workout Did Start注意到鍛鍊的開始日期
接着它生成查詢要了解流距離運動能量和心率等
它執行了我們生成的所有查詢然後告知UI鍛鍊開始
我們來看怎樣來實現
我再次選定跑步
是戶外跑步
正如大家所見計時器在走
我也在累計模擬距離樣本也顯示了部分卡路里樣本
這樣用戶可以在app的這個地方看到他們的距離 卡路里 心率等
最後我們想要支持用戶的是停止並保存鍛鍊數據
我有個Force Touch菜單其中只有一個Save按鈕
在鍛鍊結束時用戶可以點擊按鈕
我們還沒有執行它所以鍛鍊還在繼續
現在我們就動手執行
這裏是Stop Workout And Save方法 
每當用戶點擊Force Touch菜單按鈕 UI就會調用這個方法
我會在這裏停止鍛鍊會話
只要調用Stop Workout Session即可
我們需要將狀態改變到結束狀態
我們相應調用Workout Did End
這裏大家可能想到了我需要停止查詢
接着保存鍛鍊結果
我們會注意到鍛鍊的結束日期
我們會停止所有的查詢
我們會告知UI鍛鍊停止
然後我們會保存鍛鍊結果
將鍛鍊結果保存到HealthKit也相當簡單
首先我要做的是打開開始和結束日期 
我在Workout Did Start和Workout Did End見到過
我來使用Swift的最新守護語句
如果這些是零值則會提早返回
接下來用戶從事的運動類型的開始和結束日期 消耗總能量和距離
將鍛鍊實例化
我還通過在鍛鍊期間積累的所有樣本生成了一個數組
因爲我們想讓這些樣本在保存並鍛鍊結果後與之關聯
然後我會將鍛鍊結果保存到HealthKit之中
一旦完成我將會在鍛鍊結果中加入樣本
現在我們就來看一下
我再次選擇跑步類型是戶外跑步
我的鍛鍊在繼續
一旦獲得幾個指標我就會保存
我將要保存鍛鍊完成
現在我們將鍛鍊結果保存到HealthKit
我們來看下在配套app中顯示
這就是我們3卡路里的鍛鍊結果
做了不少工作
好的我們總結一下剛纔演示中的內容
首先我們請求授權訪問用戶的HealthKit數據
接下來我們使用HK Workout Session記錄鍛鍊結果
我們通過HK Anchored Object Query從HealthKit提取樣本
最後保存HK鍛鍊數據到HealthKit並將樣本與之關聯
這就是iOS 9中HealthKit的新增內容
我們今天先介紹了單位偏好API
可以實現在app中依照用戶喜愛的單位顯示HealthKit數據
接下來我們講了HealthKit儲存的新數據類型
例如Water IntakeUV Exposure
以及與生殖健康相關的信息
接着還說到源代碼修改和設備
這可以爲HealthKit中 數據從哪裏來提供更豐富的信息
我們還介紹了刪除樣本以及查詢刪掉的樣本的新方法
最後我們探討了HK Workout Session API
並介紹瞭如何用它搭建WatchKit app 
我們覺得大家會喜歡在iOS 9中對HealthKit所做的改進
我們真想看到大家能用它搭建出什麼
若想了解更多詳情可以訪問開發人員文檔資料
位置在developer.apple.com/healthKit
或是聯繫技術支持
一般性的問題可以聯繫healthkit@apple.com
感謝大家希望你們會喜歡大會的其餘部分