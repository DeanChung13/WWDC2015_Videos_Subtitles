AV Foundation編輯電影
歡迎來到506號講座我是蒂姆·門羅 是AVFoundation
工程團隊成員今天我和大家談談
在AVFoundation編輯電影的問題
講述的內容很簡單
AVFoundation 爲編輯QuickTime
電影文件提供新類
哦 好啦 你可以做得更好我們來聽聽掌聲
謝謝
我對這樣的功能感到興奮
大家一會兒就會看到這會爲我所管理的
個人項目提供工具在過去十年左右
我都在忙着這件事兒在某種程度上
這爲我過去大約35年來所做的項目
帶來了新的高度
對此我可是投入巨大希望大家喜歡今天的講座內容
我們可以編輯QuickTime 電影文件意味着什麼
我們可以打開QuickTime電影文件
對電影和軌道執行基於範圍的編輯
可以選擇一個部分電影的一個片段
複製到其他影片中
可以增減軌道
可以設置軌道間的聯繫
比如在另一個章節軌道的一個軌道上做標記
可以增加或調整軌道和電影元數據
我們可以創建電影文件
以及所謂URL樣本引用電影文件
今天你會怎麼做呢？
首先我會根據AVFoundation中
現有的類來放置這些新類
然後我會做API爬蟲文件 
其中會介紹並觸及
已經加入這些類的新方法的高點
最後我會回過頭來返回談一談
我提到的這個個人項目
其中清楚顯示了這些新功能
可以將我所蒐集的大量數據做出有趣的事情來
我們來談談AVFoundation編輯類
如果已經在編輯環境用過AVFoundation
就會知道我們將用到兩個類操作抽象類
是複合類可以獲得AVCompositions
並在可變水平實現AVMutableCompositions
現在複合類是很酷的內容
可以做出相當棒的效果
AVMutableComposition只有一點
不如人意
沒有標準文件格式用來
序列化複合類
這使得很難將你漂亮的複合類和其他應用進行互換
我們前往AVMovie和AVMutableMovie時
問題不復存在了因爲其中
有QuickTime電影文件格式
我們可以打開 編輯重新編寫
在軌道層面 我們有相似的設置
如大家所知 複合類包括複合軌道
並在可變水平
我們有AVMutableComposition軌道
在El Capitan 我們可以在軌道層面添加兩個新類
AVMovieTrack和AVMutableMovieTrack
我們的確有五個新類需要你們操心
電影和可變電影電影軌道
可變電影軌道
第五類叫做AVMediaDataStorage
這是很簡單的類全部任務
就是表明寫入文件的新樣本數據在哪裏該結束
AVMovie代表符合QuickTime電影
文件格式的視頻音頻文件數據
如果你熟悉QuickTime電影
你會知道存在若干相關文件格式
都是基於QuickTime 電影文件格式轉換而來
這些合稱爲ISO基媒體文件格式
AVMovie和可變電影可以很好地處理這些
和應對QuickTime電影文件沒有區別
這些文件的主要特點是什麼?
在我看來特點是文件格式在樣本數據
和組織樣本進入軌道和電影的數據間執行嚴格的區分
這裏是QuickTime電影文件的基本示意圖
先是文件類型框
這是非常簡單的少量數據表明這個文件
符合哪個系列中的文件格式
這裏還有個電影框我剛說過
代表所有樣本數據的組織信息
是在自身的框中可以找到
大部分的順序都是任意的
文件類型框必須在最前面
但是其他框可以是任何順序
那麼我們可以把電影框放在文件最後
可以位於兩個樣本數據框的中間
甚至可以成爲未用文件的部分
也許之前曾有過數據但是現在沒有了
現在 電影框裏是什麼呢?
這裏有我們今天要考慮的三類信息
首先是全局設置
沒有這部分信息就不會真正有電影的存在
其中包括電影中有多少軌道
電影時長是多少
文件何時生成播放時的最佳速率是什麼
電影框裏還有元數據 這屬於
可選數據 對媒體播放而言並非必不可少
但是如果具備也會有用
這有點像是版權聲明的內容
表明作者是誰片名是什麼
也許還有一些你或其他app寫入
電影框中的自定義數據
在電影框中發現的最後一項內容是軌道框這部分信息
定義了電影中的不同軌道
其中包括軌道類型
指出軌道所需的樣本數據
也包括軌道元數據
當然 如果願意 也可以在這裏編寫自定義軌道元數據
還有軌道相關性的相關信息
也就是電影中軌道和其他軌道之間的關聯
這裏的主要特點是樣本數據位置
因此樣本數據本身並不存在於軌道框中
軌道框包括到樣本數據的參考信息之類
對樣本數據而言軌道可能會
存在於其他文件中
這樣你也可以有外部樣本參考
還可以是隻有外部樣本數據的樣本參考
在這種情況下小電影框
及其文件類型框被叫做樣本參考電影文件
框中並無真實數據
它只是指向其他位置的數據
現在這成爲你與其他媒體文件
一起工作時功能非常強大的工具
爲什麼？因爲我可以編輯少量信息
而不需要觸及大量媒體數據
但是 可以想象這其中會有一些脆弱性
爲什麼呢？因爲我在參考數據數據 如果所參考的數據手
碰巧在移動或者是被刪掉我就會很糟心
我再也不能播放演示作品了
可以通過兩種方式降低這種脆弱性
主要是通過相關URL
當我製作這些樣本參考時我們會些許看到該怎麼做
在今天結束的時候大家可能會想
試試自包含電影
如果想給朋友看看或是在網頁上發送發帖
需要這麼做的時候
可以通過AVAssetExportSession
運行自己的可變電影
可以獲得極好的自包含文件
好的我們現在來看剛引入的電影編輯API
在不可變層面AVMovie是AVAsset 
不可變的子類 我們實際上做了些有趣的事情
我們可以查看電影
可以獲得電影頭文件
可以在新文件中編寫電影頭文件
所謂電影頭文件我是指文件類型框
和電影框而不是樣本數據
怎樣初始化AVMovie?
如果初始化過AVRL 就知道該怎麼做了
你提供URL我們返還AVMovie
如果有電影頭文件比如說在粘貼板上則可以進入
並從數據塊生成電影
在講座中我們不會更多探討這方面問題
但是如果你看樣本代碼包AVMovieEditor
則會清楚看到該怎樣把內容
從粘貼板提取或放置
這裏就是可以輕鬆生成樣本參考電影文件
我們將把URL作爲AVMovie打開
不好意思我們調用...
我們想生成的文件類型指示
然後是部分選項
在本例中 我們指定的選項是電影頭文件的刪節目的地
基本上而言 這是指如果有任何數據
在該URL上它都會被擠走
最後在文件中就只剩電影頭文件
還可以是不同的選項
不再擠走文件中已有的任何數據
這就是將電影頭文件添加到目的地選項
我們來繼續講AVMovie的可變子類
AVMutableMovie
這會提供基於範圍的電影編輯 增減軌道
增加或調整電影
元數據的編輯方法
怎樣初始化AVMutableMovie?
和初始化AVMovie的做法基本相同
我們會傳遞一個URL但是在本例中
我們需要能夠調整可能會出現的任何錯誤
還可以從零建造AVMutableMovie
本代碼行給我們返回空的AVMutableMovie文件
我們可以在其中添加軌道接着在軌道中添加部分數據等等
這些是在AVMutableMovie可用的片段編輯方法
如果大家用過AVMutable複合類
這很相似因爲實際上
只有一處存在例外
就是插入時間範圍方法會需要額外的參數
表明你是否要複製樣本數據
到目標文件或僅僅複製樣本參考
如果複製樣本數據到目標可變電影
你需要告知它編寫樣本數據的位置
它不會默認做任何事情
例如 它不會自己將數據編寫在電影框所在的文件中
所以必須明確規定你需要
將寫入電影的任何新的樣本數據放置的位置
可以通過規定可變電影的默認
媒體數據存儲屬性來實現
這就是該AVMediaDataStorage類出馬啦
同樣 它此刻只是包裹了URL 
有生成和刪除軌道的方法要生成軌道
必須要表明所需的軌道類型
要的是視頻軌道是音頻軌道等等
如果喜歡如果有現有軌道
希望以此複製新軌道我們把它作爲
參數傳遞 從現有軌道 使用它們採取相關的屬性
這裏有個簡單的小案例研究
爲更新現有電影文件我們可以從URL打開
使用我們剛纔所見的方法做些編輯
然後我們可以使用正確的電影頭文件
作爲URL方法 將電影頭文件寫入相同文件
這就是就地編輯
這裏 我們並未移動任何樣本數據
我們所做的就是調整電影框
並把它放回相同的文件
我們來談談軌道編輯API
這可以允許我們調整QuickTime電影文件的軌道 
我們有基於範圍的軌道編輯
正如我們在電影層面所見 
我們還可以設置軌道之間的關聯性可以增加或調整軌道元數據
這裏是片段編輯方式
它們看似熟悉因爲我們剛剛見過
在電影層面唯一的不同在於我們沒有插入資產的時間範圍 
而是插入了軌道的時間範圍
同樣 當我們插入時間範圍時 必須規定
你是否想要複製樣本數據
還是隻想放入樣本參考
如果複製樣本數據軌道必須要知道
樣本數據要去往何處
通過使用在電影層面完全相同的類 
設置軌道的媒體數據電影層面所見
這裏是另一個案例研究
假設這裏有一小段剪輯我想做靜音處理
也許這段剪輯中有部分不合時宜的語言
很簡單 只要找到電影
第一個音頻軌道定義時間範圍即希望
靜音的範圍 刪除時間範圍
在相同的點插入空的時間範圍
這個代碼的淨效果就是在原先的不當
語言處加入了空片段
處理軌道關聯性相當簡單
可以增加軌道關聯性或刪除軌道關聯性
稍後我們來看怎樣使用
我說過 當複製樣本數據進入軌道後 
我會告知大家 怎樣使用相關URL
要這樣做
打開每個軌道
我們會設置樣本參考基URL屬性
到包括電影的電影部分共同父類
包括電影框的文件和包括所有媒體數據的文件
好 我們來繼續...
講我說過的個人項目我想稱之爲
《血字(和灰字)研究》需要向柯南·道爾爵士致歉
我們回到1980年我們說的是什麼？
35年前
當時我還是伯克利海灣區那邊的研究生 
需要找個方法釋放多餘的精力
我出去買了輪滑鞋因爲我發現伯克利
是輪滑者的理想場所位置
因爲這裏有些不錯的山地
我非常喜歡我不斷去找
更高的山爬上去之後再滑下來
1984年 你們可以看到我在奧克蘭克萊蒙大道的頂端
遠處 你可以看到舊金山 是海灣區的這一側 
是愛莫瑞維爾這非常棒
幾乎就像從我面前輪滑飛馳而過
我不太清楚舉起手是做什麼
也許是爲了我們要誓死效忠的什麼東西
我可沒準備豁出命去很好
爲了跟蹤我的位置我去買了街道地圖
我把自己設成黃色高亮
我開始在地圖上標出自己去過的地方
那裏的山地非常好
如果你和我一樣這麼做會糟糕的很
因爲最後會把整幅地圖都塗滿顏色
然後是2000年 不好意思
大約是1985年我在弄一個項目
我稱之爲蒂姆的奧克蘭瘋狂輪滑之旅
或簡稱輪滑之旅目標很簡單
就是在奧克蘭的每條街道都輪滑滑過街道的全長
從1985年一直持續到2005年
所以十年前 我完成了怎麼樣？
謝謝
在奧克蘭需要滑過近800英里的公路 
才能實現這個目標
2005年完成時 我沒有位置數據
我開始時GPS還沒有發明出來
當時可能是沒有的
實際上我有所有的位置數據
因爲如果打開我的地圖
你會看到在右側都是黃色
不全是 但是阿拉米達皮埃蒙特
愛莫利維爾有整整9碼的距離
我當時沒有視頻
如果大家回想那個時候 
1985年扛的相機都是大塊頭 
還很嬌氣外出輪滑的時候肯定是不希望揹着的
所以當我完成的時候我的確是...
這是個瘋狂的項目這點我承認
我絕對沒有花心思告訴任何人這件事
可是不巧 估計《舊金山紀事報》 聽說了此事
並且寫了篇文章報道就是那種有人情味的故事
奧克蘭市參議會得知此事
通過一項決議表彰了此項
卓絕的壯舉...是他們這麼說的 不是我
奧克蘭的幾個製片人聽說此事
花費了幾年時間爲這個項目拍攝了漂亮的小紀錄片
在一年前在灣區的獨立
劇場進行了幾輪上映
簡直是太瘋狂了
在我完成這個項目大約兩年後
我開始在東海岸花了些時間
特別是在馬薩諸塞州波士頓
更是在劍橋
我想 好吧 就讓這事兒繼續上路吧
我花了幾年時間在劍橋和薩默維爾輪滑
最後產生了波士頓輪滑之旅的想法
同樣的想法 在波士頓的每條街道輪滑
大概是從2011年開始的
我看了看地圖估計需要5年時間
來完成這件事情
前幾年的冬天也不大冷
城市大小和奧克蘭差不多
在兩年半的時間我就完成了
因此在2013年5月我完成了波士頓輪滑之旅
這次我就有準備了因爲在輪滑時
我在頭盔上裝了運動攝像機
iPhone上還有GPS app
結果就是我攢了490個MPEG-4文件拍攝了
200次不同的輪滑
共有1.5萬億字節的數據
我還有GPX文件形式的GPS數據
是那種XML版本的位置數據 大家稍後會看到
有着大約150兆字節的數據
可想而知影片會是什麼樣子我們來看其中一個
這些是攝像機直接拍攝的視頻
我只是做了重新命名這樣有了日期
和文件名 會讓我更容易查找
我們在QuickTime播放器中打開
這是第二個是接在第一個的
結尾部分繼續我們來選中第一個視頻
我們可以看到陽光明媚
是在11月下旬
當時是工作日
我們來播放看得出是秋天因爲地上有落葉
如果有音頻文件也許會聽得到
當天的呼呼風聲
不過 令人感覺有些奇怪
因爲街上沒有人
沒有一個行人
我們往前快進一點
還是沒有行人只是有些車子
我在朗伍德醫療區
這裏交通很是擁堵
卻沒有人 這是商業區
沒有人<c.blue> 像個鬼城
出什麼事兒了？
我們稍後會解決這個問題
基本上我所獲得的是一以大堆乾草
還有一把銀針我製作了500小時的視頻
即便99%都沒什麼用處
那也還能找出5小時有趣的視頻
不過 部分問題是我甚至不知道這些銀針是什麼樣
因爲我不知道500小時視頻中
哪些比較重要
我知道<c.blue> 我喜歡看部分內容
這裏用了蒙太奇手法
下雪了 真的嗎？好吧
我沒看見路面坑窪嗎？
這是我最喜歡的一部分因爲大家可以看到
我在往下滑 往前滾動返回 繼續滑行
如果不是... 謝謝大家
現在我必須花錢找人幫我挑
看過全部視頻的1/50
才挑出這6個剪輯
理論上 這一大堆乾草中
會有300個精彩的摔跤鏡頭
要知道 每個跟頭5秒鐘的話
我們就會有25分鐘這類素材
這的確看起來很有趣
現在我想怎麼來用所有這些數據
我有1.5萬億太字節的視頻數據
想拿來做點什麼
我想找出那些銀針
第一步是要把每次滑輪的攝像
不同文件連接到一起
做成樣本參考電影文件這樣我可以打開編輯
而不必擔心攝像文件
第二是我想加入索引元數據
作爲電影元數據
那麼我要進入文件並做標記
好了 我這裏開始摔跤這就是摔跤的結束部分
這裏是狗開始追我的地方
這裏是它們最後覺得沒辦法抓到我的地方
這裏是我和執法官員交談這些還會繼續
我希望對所有素材都進行索引
這樣便於搜索 發現所有的銀針 可以調用
我還想加入GPS數據 還有所有的位置數據 我還什麼都沒處理
我希望把它加到文件裏
這樣可以做成定時元數據軌道
關鍵在於 我做所有這些都不會修改最初原始的攝像機文件
並可以將需要進行的數據複製數量最小化
好的<c.blue> 具體該怎樣做呢？
AVMovie和AVMutableMovie爲我們提供答案
第一個問題的解決方案相當簡單
我準備用這些攝像機文件
生成樣本參考電影文件
它會指向兩個原始文件
非常簡單就是樣本參考電影文件的標準用法
第二步的解決方案會在電影框中
加入一些額外的自定義元數據
第三步是在新的樣本參考電影文件中
加入真實的媒體數據
這些媒體數據 即便叫做定時元數據
也是作爲媒體數據或樣本數據存儲
並會進入文件的新軌道
我準備這麼來處理問題
第一步其實非常簡單
作爲可變電影打開第一個的電影
我們會打開第二個以及任何後續的電影作爲URL資產
我們會在準備插入的資產中定義範圍
這就是整個資產時長
我們會在可變電影的結尾將它插入
可變電影中記住不要複製樣本數據
我最後只要樣本參考
最後 我們所需要做的就是在新文件中 
編寫新的電影頭文件生成樣本參考
電影文件來指向兩個原始攝像機文件中的數據
我們來看部分演示
看怎樣解決第二個和第三個問題
通常 這個幻燈片是閱讀演示
但我對好的迴文沒有免疫力
而且也不願意浪費
Alvin是基於AVFoundation
的線性索引器的縮略
就是用來做我說過的索引工作
而且可以把位置數據加入文件中
UI大概是這樣
我把電影視圖放在左邊地圖視圖放在右邊
下面可以看到有些顯示區
是我搜集來的輪滑相關信息的顯示
我們繼續打開電影文件
這是我剛生成的樣本參考電影文件
打開 我準備加載GPX文件
我會選擇適當的GPS文件
我打開文件時
需要填寫部分數據它會指出這將用多久完成
怎樣？好了 我可以擴展地圖視圖
清楚顯示我們在哪裏我出去在布魯克林四周兜了一圈
這很適合你這裏是洛根機場
絕對是波士頓
這裏是劍橋
我們仔細看看
哦 我說過要給大家看GPX文件
GPX文件就是這個樣子
是XML格式經緯度 海拔 時間標記
就是它了 再沒別的
我們來這裏運行Web服務
我出去到政府Web服務器看看當天的天氣情況
怎樣我發現當天風很大
風速平均每小時17英里對喜歡用公制的人來說
就是28.439華氏度
還有種有趣說法3.9攝氏度
那天是感恩節所以街上沒有人
對了 這說明那天正好過節還是猶太光明節的第二天
對吧？來看這些WebServices這就可以讓我們
推斷出爲何街上沒人
我跑到另一個Web Service
叫做反向地理編碼我會從Apple服務器
發出經緯度它會返還
州 城市 街道的樣子
有時甚至還有門牌號
基本上 就會提供我所經過的街道信息
等一下 所有的街道圖釘會落下
然後我們可以選出一個來看是哪條街道是聯邦大道
或是布魯克林的華盛頓大街
我這裏還加了搜索條可以輸入
比如聯邦大道如果發現就會標亮
如果把數據放入文件
現在就完成了街道名稱的可搜索性
我可以進入 找到所有在某條街道的小剪輯
我們可以隱藏這些需要做的最後一件事
就是用地址數據同步視頻
我試過各種自動方法來完成
結果發現最好的辦法只有一種 就是前往
我視頻中的幀 這裏我知道在地圖上自己的位置
然後我會來到地圖 
點擊並同步視頻和這個位置
現在 當我這麼做時如果返回並開始播放視頻
大家會看到圖釘會沿着視頻移動
看 這就是在同步
我甚至可以前往另一個方向
我去地圖上的某個位置可以點擊
讓視頻到這裏現在我就在聯邦大道了
我知道這裏是很有趣的下坡路段
我們可以滑行一秒鐘
這就是我們這麼做的原因這類下坡沒有
汽車經過會有什麼狀況呢？
好的這就是Alvin
大家可以看出Alvin可以幫我解決第二和第三個問題
可以添加自定義元數據到樣本參考電影文件
基本是這樣的
通過調用... 將現有的元數據
來看元數據屬性
我們會生成新的元數據項
我們會相應填入屬性
例如 平均風速值是我從政府服務器
獲得的當天天氣情況數據
我還創建了部分識別器可以以後查找
一旦把這些寫入文件加上正確的電影
頭文件到URL電影就全部升級了
我們再來看看第三步
是將位置數據作爲定時元數據軌道
大家已經知道該怎麼做了
如果去年來過
聽過《駕馭音頻視頻媒體中的元數據》講座
其中他們介紹過兩個內容
首先從捕獲會話得到位置數據
以及怎樣將正確時間的元數據加入電影
我們可以獲得位置數據在GPX文件中
我們並不需要捕獲會話內容
我們可以關注在第二個樣本
代碼包中獲得源代碼
並把它放入Alvin
現在 我們一旦完成在盤裏會得到
帶有單個元數據軌道的定時文件
我們所需要做的就是複製軌道到
電影的新軌道中可以打開通過GPS資產來實現
我們接着會運用
軌道中恰好有的媒體類型在電影文件中
添加新軌道我們會從軌道中複製設置
最後 我們將範圍插入新軌道
同樣如果在文件中編寫頭文件 我們弄好了
現在需要做的最後一件事這是可選內容
就是在定時媒體軌道和元數據的任何軌道之間
生成軌道關聯性在本例中我們已經選定了視頻軌道
如果跳過這一步定時視頻軌道
則會整體運用到文件中關於這些 我們都沒問題
如果你們在用AVMutableMovie
這裏還要注意兩點
如大家所知 AVMovie 或AVMutableMovie
屬於AVAsset因爲它是子類
如果可將AVAsset做什麼處理的話可以用在可變電影中
例如 可以用AVPlayerItem來播放
可以用AVAssetImageGenerator從中抓取圖像
可以用AVAssetExportSession來輸出
如果在可變電影中進行任何這樣的操作
我們非常建議你對可變電影
進行拷貝 因爲如果你在輸出時 
是在改變電影文件要以防不測
只要進行拷貝在輸出即可一切都沒問題
第二個最佳實踐是如果你在打開
希望插入AVMutableMovie的資產
則應該設置這個旗標AV URL資產喜好精確時長
和定時鍵爲真 
現在我們並未在大家已經見到的任何
代碼片段中這麼做因爲你打開QuickTime電影文件時
旗標已經設置爲真
但是如果需要打開MP3文件
例如希望將之插入可變電影文件
你需要設置這個旗標
我們來總結一下
我們加入了新類來支持QuickTime電影文件
我希望如大家所見這讓我們的工作流程
會變得非常簡單非常不錯
我們可以處理參考電影 而不是原始的電影本身 
因此 如果在處理大量的數據這會非常得力
如果想在知道在實踐中怎麼操作
下載AVMovieEditor仔細看看
若想了解更多詳情就去標準場所
如果這方面存在問題在週四和週五我們會在實驗室
如果想看看
怎樣運用複合類轉到2010年的講座看看
最後 如果大家想詳細瞭解怎樣進行
定時元數據軌道生成
可以看看去年的講座《在音頻視頻媒體中駕馭元數據》
非常感謝