Safari可擴展性的最新內容
<br/> 大家好
我是布萊恩·溫斯坦
是Safari和WebKit的工程師我來這裏和大家
聊聊《Safari可擴展性的最新內容》
今天 我們會介紹擴展Safari的幾種新方法
你可以爲iOS和OS X編寫內容攔截器
Safari ExtensionsGallery也有改變
還有新的app擴展類型 可以將你的
內容直接加在Safari的Shared Links中
我們這就開始直入正題 談談
內容攔截器
我們先來看一個大問題：
內容攔截器是什麼？
內容攔截器確定了頁面上的內容子集或
資源不會顯示或者都不會加載
我相信大家都可以設想自己在瀏覽Web時
有意攔截的內容
可以通過兩種重要方法使用內容攔截器
來攔截內容
可以在頁面隱藏元素或一併攔截
加載資源
一段時間以來 你可以在OS X上使用Safari擴展
來實現這個功能但是如今 我們讓
iOS也有了這個功能
App會提前告知Safari它們想要攔截的內容
而不是在實際加載過程中Safari諮詢
app是否進行攔截
這種新模式快速而高效 
因爲Safari不需要 在加載時 
諮詢app 
內容攔截器被編譯成字節代碼
這樣可以高效地進行評估
除此之外 新模式可以很好地保護用戶隱私
因爲內容攔截器不會瀏覽
用戶在做什麼
要創建內容攔截器你需要在
iOS上生成app擴展這會返回一個列表
包括你想攔截的內容
規則列表的JSON字符串
這裏是我常去的網站作者會介紹 
他打球的不同球場 還有
一些漂亮的圖片
但是網站有些內容很是煩人
我希望編寫內容攔截器
來攔截那些讓我煩心的內容
最顯眼的惱人之處是左側的
點擊誘餌鏈接
在我滾動頁面時它們甚至都不離左右
我們來編寫規則隱藏這一元素
首先來看 我們應該隱藏哪個元素
來看網絡檢測器我們看div存在ID泄露問題
在網絡檢測器中選中時
我們實際上在設備上做了覆蓋
顯示這是需要隱藏的正確元素
那麼我們現在知道該隱藏的元素
我們來編寫規則完成此事
每項規則 每項內容攔截規則都是
包含動作和觸發器字典的JSON對象
這個動作告知Safari該做什麼
觸發器告知Safari
何時要採取相應的行動
我們先來看看隱藏這個元素的
動作字典 是要隱藏這個元素
我們的動作就是將類型CSS不顯示
也就是說我們在頁面元素應用
不顯示樣式
當動作類型爲CSS不顯示時
在動作字典中會用到選擇器
所有的選擇器都得到Safari支持
WebKit是得到內容攔截器支持
在本例中 我們想
用ID Link來攔截內容
現在我們來定義何時想要採取這個行爲
會用到觸發器字典來實現
因爲Links是相當泛型的選擇器 可以用於
其他頁面的真實內容
我只想讓這個規則
在用戶位於bigbearsgolfblog.com頁面時應用
如果我想讓規則在用戶位於
bigbearsgolfblog.com以外的任何站點運用
我會只將如果域值祕鑰
替換爲除非域值
並保持相同值
我希望在加載任何資源時都應用這一動作
同樣只要我在bigbearsgolfblog.com
我就會設置作爲正則表達式的URL過濾器
在下載的每個URL資源上運行
以便匹配所有的URL
在稍後的例子中
我們會再說說URL過濾器
我們來看這個規則放在一起是什麼樣子
我們有動作類型CSS不顯示
也就是說我們在隱藏元素
選擇器用於描述我們隱藏的元素
接着在觸發器裏
我們說明想要這個樣式運用到哪個域名
在加載時 我們希望將它用在哪些資源
在運用內容攔截器時
網頁是這樣的
鏈接列表不復存在 我可以
集中在感興趣的內容上來
但是
當我看着Web檢測器時
發現頁面上還有一處煩人的內容
如果你來看頁面的資源
就可以看到從example.com
加載的腳本名爲Trackingscript.JS 
這個腳本實際上
在跟蹤我訪問的不同頁面
這樣可以從我的瀏覽歷史中
可以搭建出我的配置 
當我在看控制檯時
它會幫助警告我
稱我被跟蹤了
感謝 Tracking腳本
我會在加載時一起攔截這個腳本
我們先來定義這個規則的動作 
動作類型爲攔截
是指我們會攔截
匹配相應觸發器的任何資源加載
我們來看這個觸發器
觸發器會定義動作何時應啓動
但是在本例中我們已經定義過URL過濾器
資源類型和加載類型
當三項內容 URL過濾器資源類型和加載類型
全部匹配 觸發器就會啓動
我們先來介紹URL過濾器
這是個正則表達式
在所被要求的每個URL上
都會運行
在這種情況下它會與任何包括
字符串Tracking 的下劃線腳本相匹配
這將匹配
example.comTrackingscript.js
觸發器的其餘組件
會提升觸發器的針對性
我們並不需要攔截的內容矯枉過正
首先我們要的是確定一組
資源類型來匹配
在本例中 我們只想攔截加載腳本
所以把腳本作爲我們希望匹配的資源類型
最後 我們規定了第三方的加載類型
加載類型可能爲兩個值
是第一方和第三方
當加載是來自相同的方案 域名和端口時
則被視作是第一方
作爲頁面的主要資源
在我們的例子中我們只希望攔截
第三方加載的跟蹤腳本
也就是說如果用戶是在example.com
腳本仍然會成功加載
我們來看規則放在一起是什麼效果
當我們配合這個內容攔截規則重新加載頁面時
大家可以看到
我們根本沒有加載
我們根本沒有加載
Tracking script.js
控制檯沒有給出警告
稱我們被跟蹤
非常棒！
因此
你的內容攔截器會成爲這些規則
的JSON數組
現在 你已經描述了想要攔截的內容
下一步就是在iOS設備上獲取
內容攔截器
我剛纔說過 iOS上的 內容攔截器是
從app擴展中加載
很簡單 你可以自己做一個
開始時 你只需要在項目中添加新目標
從iOS應用擴展列表中選擇內容
攔截器擴展
當設置在啓動了你的內容攔截器 
app擴展就會被實例化
與其他的app擴展類似
它是默認關閉狀態
Safari會把你的規則編入字節代碼
這樣每次啓動
Safari時 就會加載並快速評估
一旦你生成了app擴展
就會有動作請求處理器
像這樣
app擴展所做的就是在app擴展實例化時 
將攔截器
list.JSON的內容返回Safari
攔截器list.JSON自動進入
你的擴展目標編寫自己的內容攔截器
你所需要做的就是
填寫這個JSON文件
此外
內容攔截器自動用於Safari
或任何使用
Safari View Controller的app
如果你有顯示Web內容的app
則應該查看本週早些時候
介紹Safari ViewController的講座內容
但是
對部分app而言靜態攔截表 
還不夠
你可能想提供內容攔截器的
自定義內容
或是讓用戶從
諸多不同攔截表中選擇
或是讓用戶選擇他們不想運用的具體站點
爲此
和其他 app擴展一樣
我們建議你把管理設置放入app
當用戶採取的動作會改變
攔截表的內容時
你只需要告知
Safari重新實例化app擴展
這將導致內容攔截器被重新編譯
爲此
我們在Safari服務框架中
的新款API
名爲SF內容攔截器
管理器重新加載帶有標識符的內容攔截器
你只需要傳遞內容攔截器的
束標識符
這將導致Safari重新運行app
擴展並升級解析內容
攔截器生成的字節代碼
這不過是內容攔截器可實現的部分功能
可見開始製作自己的內容攔截器是多麼簡單
我想有請阿萊克斯·克里斯滕森來做演示
阿萊克斯?
<br/> 謝謝 布萊恩
我是阿萊克斯·克里斯滕森來自Safari和WebKit
我將給大家展示如何在iOS製作內容攔截器
我們會通過兩種方式 攔截內容
我們將在Web頁面隱藏部分元素
我們還會攔截部分加載
現在
我不瞭解大家會怎樣但是我自己是時常在
Web衝浪
感覺的確可以通過刪除
部分網頁內容的擴展
來提升用戶體驗
大家看看我收藏的Web頁面
大家就會明白我是在說什麼
就這樣
哦！我就喜歡這樣的Web頁面
我可以瞭解可愛小狗圖片的世界上
在發生什麼
這些內容 我每天至少會查看一個 
寶貴的屏幕空間非常有限
這裏的評論有些煩人 而且還佔用了
寶貴的屏幕空間我本想留着
放可愛的小狗照片的
我們進入Web檢測器 
來看這個問題該怎麼解決
在Mac上打開Safari
如果進入開發菜單模擬器
可愛的小狗和cats.com
大家可以看見 
我們要檢查這個iOS模擬器實例
如果我們按住鼠標可以看到
這就是我想隱藏的div
這是個類評論
如果我們研究Web頁面的結構就會看出
我想隱藏的其他div
也都有類評論
編寫選擇器div.comments非常簡單
可以發現 頁面上我想隱藏的所有元素 
都使用了CSS不顯示樣式
我們來制定規則在iOS內容攔截器中完成這個任務 
打開Xcode 生成新項目iOS 
單視圖應用
我的app希望大家能有比"我的app"更好的名稱
在桌面上生成它
好
從這裏我們進入文檔
新建
目標
在iOS下
應用擴展
這裏有內容攔截擴展模板
就是布萊恩剛說過的那個
我的內容攔截器
我們不要激活這個方案 因爲我們
要在iOS模擬器上 運行app
加入新的目標
變成這個樣子：
mycontentblocker
在其中
生成了攔截器list.JSON
我們準備把規則放在這裏
現在
我有應用於
選擇器div.comments的規則
並把樣式CSS不顯示應用於選擇器匹配的
頁面所有元素中
我們現在把這個應用到所有地方
用點星號正則表達式
代表所有地方
在模擬器中運行
這就是我的app
好的
如果我們進入設置
Safari
內容攔截器
這是我的app的內容攔截器
我們把它打開
重新加載頁面 看看它會做什麼
所有評論都不見了
我可以把屏幕空間
放可愛的小狗照片我來這個站點就是這個目的
如果仔細看你可能會發現
有一幅圖 不是可愛的小狗照片
我其實是個愛狗人士 而不是愛貓人士
我不想看到這些貓咪的照片
(Laughter)我不想等到這些貓咪照片都加載下來
也不想把帶寬用在下載
我根本不想要的
貓咪上面 我們把這些加載完全攔截掉
回到Web檢測器和資源選項卡
大家可以看到這個頁面上的資源
有些名稱我可以通過編寫正則表達式識別出來
如果包括斜槓
貓咪那可能就是貓咪照片
我們攔截這些加載
這裏我還有個規則
動作類型攔截
如果匹配正則表達式
斜槓貓咪 我們就攔截它
我覺得這有點太過泛型
我估計這樣可能會攔截掉一些
我不想攔截的頁面比如任何位置的URL
要是有這樣的斜槓類型就會被攔截
但是這可能會導致問題
我們先這麼用在
cutepuppiesandcats.com之中我相當肯定
網站上若有斜槓貓咪的URL 可能就是
我想要攔截的貓咪照片
好的 我們來運行一下看看會怎樣
我們回到設置中做轉換  
並重新編譯內容攔截器
你還可以使用API從app內部完成這個任務
返回Safari
重新加載頁面
就這樣
貓咪照片不見了
但有些內容出現了問題
小狗照片太大了
沒有背景顏色
看似CSS也不見了
<br/> 我們肯定不想這樣
我們回到設置中Web檢測器
看看是怎麼回事
這裏
大家會看到
CSS在URL中
還是以 /cat開頭
是貓咪和dogs.css
我們無意中把它攔截了
有兩種辦法
來解決問題
我們還有一個規則
只適用於圖像或...
可以有些創意
但我會這麼做
如果匹配了貓咪和小狗
我們想忽略掉攔截的規則
就這樣
其中有貓咪和小狗就忽略之前的規則
這會攔截貓咪圖片這是我想要的樣子
但是會讓貓咪和dog.css通過 
好的 我們再來運行一下
切換 重編譯內容攔截器
並重新加載頁面
就這樣
我希望內容攔截器的用戶像這樣
來查看網頁
直接就是小狗照片
好
今天 我們攔截了部分貓咪照片隱藏了一些評論
誰知道明天你想攔截什麼內容呢？
隨你啦
試着在iOS上製作內容攔截器吧
布萊恩 上來吧
<br/> 謝謝 阿萊克斯
剛纔是對怎樣
在iOS生成製作內容攔截器進行綜述
其中只是介紹了可實現的部分功能
因爲我們覺得攔截列表模型是
攔截Web內容的最好方法
我們已經把
相同的模型通過傳統的Safari擴展API帶回Mac
幾年前 大家就可以使用Safari
攔截內容但是當前的攔截模型
可以反向影響用戶瀏覽的
效果
有了這款新的攔截列表模型 因爲Safari
在任何加載發生之前 就知道了攔截列表
速度就會快很多
因爲我們已經優化了這些攔截列表
生成的編譯字節代碼
也會大幅提高內存效率
如果有人使用...編寫擴展
如果有人過去編寫過內容攔截擴展
他們會瞭解可加載方法
所以我們在反對可加載方法
如果Safari擴展規定了攔截列表
調用可加載會變成擴展中的停止操作
在Safari擴展中增加內容攔截器
你只需要在Safari的擴展構建器中
設置內容攔截器文檔
這可以是你的iOS app所用的完全相同的JSON文檔
但是 如果你想爲用戶提供
攔截內容的自定義選項
同樣要讓他們從不同的攔截列表中選擇
或者當用戶在具體頁面時讓攔截列表
不能適用我們已添加了JavaScript API
來動態配置你的內容攔截器
你可以從擴展的全局頁面調用
Safari.extension.set內容攔截器
並傳遞至內容攔截器
內容攔截器
可以是對象
或JSON字符串
API二者都接受
剛纔是對iOS和OS X
的內容攔截器進行綜述
當我們談論傳統的Safari擴展時
我們對
Safari ExtensionsGallery有所改變
若有誰不熟悉Safari Extensions
Gallery 它其實是用戶發現Safari 
擴展的最佳位置
可以直接從Safari的菜單
並從Safari的擴展偏好直接訪問
只有在這裏
用戶點擊一下即可安裝擴展
如果你對製作Safari擴展很是認真
你現在就已經在這個庫裏了
我之前說過 這裏是用戶發現並
安裝擴展最便捷的位置
爲了用戶的安全起見
很快庫裏的所有
擴展都會由Apple簽署並主持
利用這一點你只需向
庫中重新提交擴展即可
還有一點非常棒的是
一旦你已經向庫提交過一個版本
如果提交更新的話用戶會自動
免費獲得擴展的更新版本
你不必再編寫更新清單
但是如果你的版本在庫中沒有
當你想讓用戶更新庫中的
最新版本時你需要在更新
清單中添加新的旗標說明
Safari應更新擴展到
庫中的版本
很快
自動更新將僅適用於
ExtensionsGallery中的擴展
這些是Safari ExtensionsGallery
所做的改變
我來介紹本次講座的最後一項內容
Shared Links app擴展
Shared Links是一項Safari功能
就在書籤和
閱讀列表旁
其中包括你感興趣的
不同來源的鏈接流
推特 領英 微博賬戶的鏈接
都會自動顯示
此外 在iOS 8和Safari Yosemite版本
我們爲用戶增加了收藏網站
RSS訂閱功能使其可以直接
在Shared Links顯示
在截屏中 大家可以看到我的推特賬戶以及
訂閱的部分網站是分散狀態
在iOS 9和Safari的OSX ElCapitan版本中
我們添加了新的方法
可以直接在Safari的Shared Links中獲取內容
這些是SharedLinks app擴展
這是新的app擴展類型
對於iOS和OS X有着同樣的API
先從生成新app擴展開始
就像我們剛介紹內容攔截器時那樣
你生成新的目標在感興趣的平臺
選擇Shared Links擴展
若要app擴展能在高層級運行
這需要在正確的時機調用app擴展
你會返回NSExtension項的列表
在Shared Links app擴展的情況下
每個NSExtension會直接轉爲
Shared Links項
這裏有NSExtension項的白板 還有我們
準備生成的Shared Links項
我將向大家介紹怎樣通過代碼來完成
先在NSExtension項定義部分用戶信息
我們首先要定義的是每個NSExtension項的
標識符
app擴展返回的
NSExtension項不會有重複的標識符
接着來定義URL字符串當用戶選擇Safari的
Shared Links項時這就是加載的內容
然後 我們定義SharedLinks項的出版日期
Safari使用每項的日期
在用戶的Shared Links內部
不同來源分散項 
最後
你可以定義顯示名稱
這會在Shared Links項的頂部顯示
要注意兩點
獨特的標識符必須與擴展的
多種實例化相一致
如果擴展需要多次調用
並返回相同的Shared Links項
獨特的標識符需要是時間相同
顯示名稱可以完全可選
如果沒有設定 Safari將使用
Shared Linksapp擴展的顯示名稱
然後 我們定義Shared Links項的標題
這就是NSExtension項的屬性標題
然後定義SharedLinks項的說明文字
即NSExtension項的屬性內容
文本
如果內容太多 二者都會
自動省略
這是Shared Links項的全部文本
我們看到的圖像會怎樣呢？
左上角的圖標是NSExtension項
附件數組中的首次輸入
在本例中 我會使用擴展束中的一個圖像
但是你可能會從這裏的Web抓取一個圖像
右上角的圖標就是你的app圖標
因此如果返回多個Shared Links項
而且是不同的顯示名稱
右上角的圖標將提供app的品牌化
讓用戶知道這些內容是來自你的app
一點提示 如果這是首次使用NSExtension項
那麼NSExtension項的所有屬性
屬性標題屬性內容文本
和附件 必須在設置用戶信息後完成設置
這就是從Shared Links內部獲取內容的全部所需
我想有請阿萊克斯回來 介紹另一個演示
阿萊克斯?
好
我有些內容想放在SharedLinks當中
我會製作Shared Links擴展
先來給大家看看我說的是什麼意思
好
如果打開Safari大家可以看到在側邊欄
我有一束來自推特賬戶訂閱的鏈接
我希望把Shared Links 擴展的用戶準備的內容
放在這裏
我們來製作Shared Links擴展
打開Xcode
生成新項目
我們按照OS X來做但是在iOS上也一樣
現在 把它放在桌面
好的現在 從這裏進入文檔新建 目標
在OS X應用擴展下這裏有Shared
Links擴展模板布萊恩剛給大家看過
我們繼續
My Shared Links擴展
這個名稱不錯
激活擴展方案
好 我們激活了因爲想要
在Safari上運行擴展
現在新的目標
形成了My SharedLinks擴展
它把模板Swift放在這裏
這個Swift非常簡單
它剛生成了NSExtension項填入了用戶信息
提供了屬性標題和部分上下文文本
不好意思 是內容文本
它用一個數組調用了完全請求返回項
在本例中 就是一項
我們來看看它在框外做了些什麼
用Safari來運行
我們用Xcode進行調試
工具想知道目前發生的情況
就這樣
這裏我們有來自My Shared Links
擴展的部分內容如果我點擊它
就會被帶到Apple.com 非常棒
這就是模板表示的內容
現在 不過我希望把內容放在這裏
我想把Swift稍作調整
我帶大家看一下怎麼做
非常簡單
只要發送NSURL請求
到我的服務器
HTTPS
一定要用HTTPS
cutepuppiesandcats.com
斜槓data.JSON
我給大家看看發送請求後 
將會收到的代碼
就是帶有幾個鏈接的
JSON API
還有我想放入
Shared Links的部分內容
好
這會生成一個請求獲得JSON
它會爲解析的
JSON數組的每個值解析JSON
從中會得到一些字符串
它會填入通過部分
內容製成的NSExtension項
我將URL作爲獨特的識別符 因爲我知道
對於我的數據而言它們都是獨特的
如果這對你的數據而言不是這樣
那麼就想辦法爲每個獲得獨特的值
我有個圖標
需要添加
就這樣
就是我的小狗圖標
我把它的位置放錯了
我們把它放在演示中
我需要加上它
加上小狗圖標
我還要加
在這個目標上
My Shared Links擴展
那麼 My Shared Links擴展
就可以訪問這個圖標
我們現在來運行一下
我們來看看會怎樣
首先關閉Safari
就這樣
我們就來運行這個看看會怎樣
工具需要了解目前發生的情況
我的內容還沒有顯示
我們來看看是什麼問題
如果直接看這裏
會看到一系列錯誤
如果打開控制檯來看系統
日誌控制檯你會看到
一系列沙箱異常
這是因爲
我的擴展是沙箱的
爲確保用戶安全
這些擴展只能訪問有必要的內容
這一獨特的擴展
現在還不能訪問網絡
我們試着提出NSURL請求
我們的確需要
訪問這個網絡
如果我點擊
這裏的項目
然後進入功能
這裏
我需要檢查對外的連接
以便
這個擴展
可以發送
初始的對外連接以獲取
JSON數據 
好
好 我們運行一下
就這樣!
就在我們想要的位置
現在有了內容
以及內容的鏈接
我可以將用戶
從Safari Shared Links帶到網站
如果有內容想要放入
Safari Shared Links
試着製作Shared Links擴展
好的 該你了 布萊恩！
<br/> 謝謝 阿萊克斯
跟我們演示了幫助用戶
幫助用戶使用SharedLinks app擴展
發現你的內容是多簡單的事情
我們今天都聊了些什麼？
我們介紹了爲iOS編寫
內容攔截器的功能
如果你在Mac上有內容攔截器
你就肯定會用到這個新款API
它可以爲用戶提供更快
內存更高效的瀏覽體驗
若在Safari ExtensionsGallery
有擴展請再次提交
這樣你的新版本就可以得到Apple的簽署和主持
如果在這裏沒有擴展
現在就是開始的絕好時機
最後
如果你有一組鏈接在Shared Links中
可以運用你現在可以直接
把它們放在Safari這樣用戶就可以
找到它們 並返回你的網站
如果有任何問題可以聯繫約翰·戴維斯
我們的Web技術開發顧問
很快
我們還有博客介紹Safari
內容攔截的所有功能 是在
WebKit.org博客上
儘可以通過Apple開發人員論壇和我們聯繫
有關講座如果你有app
其中會顯示Web內容
可以查看《介紹Safari視圖控制器》的部分
正如大家所見我們用Web檢測器
幫助生成內容攔截器
若想了解Web攔截器的更多詳情
可以查看《使用Safari來交付和
調試響應式Web設計》講座
我將...
阿萊克斯和我 在本次講座後會直接去媒體實驗室A
如果有問題 就來找我們
謝謝！祝大家週五過得愉快